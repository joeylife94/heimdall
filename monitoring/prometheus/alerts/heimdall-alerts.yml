groups:
  - name: heimdall_alerts
    interval: 30s
    rules:
      # 서비스 다운 알림
      - alert: HeimdallServiceDown
        expr: up{job="heimdall"} == 0
        for: 1m
        labels:
          severity: critical
          service: heimdall
        annotations:
          summary: "Heimdall 서비스가 다운되었습니다"
          description: "Heimdall 인스턴스 {{ $labels.instance }}가 1분 이상 응답하지 않습니다."

      # 높은 에러율
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{application="heimdall",status=~"5.."}[5m]))
            /
            sum(rate(http_server_requests_seconds_count{application="heimdall"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "높은 에러율 감지"
          description: "최근 5분간 에러율이 5%를 초과했습니다. 현재 에러율: {{ $value | humanizePercentage }}"

      # 높은 응답 시간
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_server_requests_seconds_bucket{application="heimdall"}[5m])) by (le)
          ) > 1
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "높은 응답 시간 감지"
          description: "P95 응답 시간이 1초를 초과했습니다. 현재 P95: {{ $value }}s"

      # 메모리 사용률 높음
      - alert: HighMemoryUsage
        expr: |
          (jvm_memory_used_bytes{application="heimdall",area="heap"} 
          / 
          jvm_memory_max_bytes{application="heimdall",area="heap"}) > 0.85
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "높은 메모리 사용률"
          description: "Heap 메모리 사용률이 85%를 초과했습니다. 현재: {{ $value | humanizePercentage }}"

      # CPU 사용률 높음
      - alert: HighCPUUsage
        expr: rate(process_cpu_usage{application="heimdall"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "높은 CPU 사용률"
          description: "CPU 사용률이 80%를 초과했습니다. 현재: {{ $value | humanizePercentage }}"

      # Kafka Consumer Lag 높음
      - alert: HighKafkaConsumerLag
        expr: kafka_consumer_lag{application="heimdall"} > 1000
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "Kafka Consumer Lag 높음"
          description: "토픽 {{ $labels.topic }}의 Consumer Lag가 1000을 초과했습니다. 현재: {{ $value }}"

      # 로그 처리 지연
      - alert: LogProcessingDelay
        expr: |
          (rate(logs_ingested_total{application="heimdall"}[5m]) 
          - 
          rate(logs_processed_total{application="heimdall"}[5m])) > 10
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "로그 처리 지연"
          description: "로그 수집과 처리 간 격차가 발생하고 있습니다. 차이: {{ $value }}/s"

      # 데이터베이스 연결 실패
      - alert: DatabaseConnectionFailure
        expr: hikaricp_connections_active{application="heimdall"} == 0
        for: 2m
        labels:
          severity: critical
          service: heimdall
        annotations:
          summary: "데이터베이스 연결 실패"
          description: "활성 데이터베이스 연결이 없습니다. DB 연결을 확인하세요."

      # JVM GC 시간 높음
      - alert: HighGCTime
        expr: |
          rate(jvm_gc_pause_seconds_sum{application="heimdall"}[5m]) 
          / 
          rate(jvm_gc_pause_seconds_count{application="heimdall"}[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "높은 GC 시간"
          description: "평균 GC 시간이 500ms를 초과했습니다. 현재: {{ $value }}s"

      # 디스크 공간 부족
      - alert: LowDiskSpace
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"}
          /
          node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: warning
          service: heimdall
        annotations:
          summary: "디스크 공간 부족"
          description: "사용 가능한 디스크 공간이 10% 미만입니다. 현재: {{ $value | humanizePercentage }}"
